<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking Control System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      * {
        font-family: "Inter", sans-serif;
      }

      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .input-field {
        transition: all 0.3s ease;
      }

      .input-field:focus {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .sidebar-item {
        transition: all 0.3s ease;
      }

      .sidebar-item:hover {
        background: rgba(102, 126, 234, 0.1);
        transform: translateX(4px);
      }

      .sidebar-item.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .page-container {
        display: none;
      }

      .page-container.active {
        display: block;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Main App Container -->
    <div id="app"></div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
      // ========================================
      // GLOBAL VARIABLES & STATE
      // ========================================
      let currentUser = null;
      let currentPage = "login";

      // ========================================
      // SHARED UTILITY FUNCTIONS (ใช้ทุกหน้า)
      // ========================================

      /**
       * Toast Notification Function
       */
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        const bgColor = type === "success" ? "bg-green-500" : "bg-red-500";

        toast.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg mb-4 transform transition-all duration-300 translate-x-full`;
        toast.innerHTML = `
        <div class="flex items-center space-x-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${
              type === "success"
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
            }
          </svg>
          <span>${message}</span>
        </div>
      `;

        document.getElementById("toastContainer").appendChild(toast);

        setTimeout(() => {
          toast.classList.remove("translate-x-full");
        }, 100);

        setTimeout(() => {
          toast.classList.add("translate-x-full");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      /**
       * Update DateTime (ใช้ใน main.html)
       */
      function updateDateTime() {
        const now = new Date();
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        };
        const dateTimeElement = document.getElementById("currentDateTime");
        if (dateTimeElement) {
          dateTimeElement.textContent = now.toLocaleDateString(
            "th-TH",
            options
          );
        }
      }

      // ========================================
      // PAGE LOADING & NAVIGATION
      // ========================================

      /**
       * Load Page Content
       */
      function loadPage(pageName) {
        currentPage = pageName;
        const app = document.getElementById("app");

        google.script.run
          .withSuccessHandler(function (html) {
            app.innerHTML = html;

            // Initialize page-specific functions
            if (pageName === "login" && typeof initLoginPage === "function") {
              initLoginPage();
            } else if (
              pageName === "main" &&
              typeof initMainApp === "function"
            ) {
              initMainApp();
            }
          })
          .withFailureHandler(function (error) {
            app.innerHTML = `<div class="p-8 text-center text-red-600">เกิดข้อผิดพลาด: ${error.message}</div>`;
          })
          .include(pageName);
      }

      /**
       * Navigate to Page (for internal navigation within main app)
       */
      function navigateTo(pageName) {
        // Hide all page containers
        document.querySelectorAll(".page-container").forEach((page) => {
          page.classList.remove("active");
        });

        // Show selected page
        const targetPage = document.getElementById(`page-${pageName}`);
        if (targetPage) {
          targetPage.classList.add("active");

          // Update active menu
          document.querySelectorAll(".sidebar-item").forEach((item) => {
            item.classList.remove("active");
          });
          const activeMenu = document.querySelector(
            `[data-page="${pageName}"]`
          );
          if (activeMenu) {
            activeMenu.classList.add("active");
          }

          // Update page title
          const titles = {
            dashboard: { title: "Dashboard", subtitle: "ภาพรวมระบบ" },
            booking: {
              title: "จัดการการจอง",
              subtitle: "สร้างและจัดการการจองทัวร์",
            },
            employees: {
              title: "จัดการพนักงาน",
              subtitle: "จัดการข้อมูลพนักงานและสิทธิ์การใช้งาน",
            },
          };

          if (titles[pageName]) {
            document.getElementById("pageTitle").textContent =
              titles[pageName].title;
            document.getElementById("pageSubtitle").textContent =
              titles[pageName].subtitle;
          }

          // Call page-specific load functions
          if (pageName === "dashboard" && typeof loadDashboard === "function") {
            loadDashboard();
          } else if (
            pageName === "booking" &&
            typeof loadBookings === "function"
          ) {
            loadBookings();
          } else if (
            pageName === "employees" &&
            typeof loadEmployees === "function"
          ) {
            loadEmployees();
          }
        }
      }

      /**
       * Logout (ใช้ใน main.html)
       */
      function logout() {
        google.script.run
          .withSuccessHandler(function (response) {
            showToast(response.message, "success");
            setTimeout(() => {
              loadPage("login");
            }, 1000);
          })
          .logoutUser();
      }

      // ========================================
      // INITIALIZATION
      // ========================================

      window.onload = function () {
        // Check if user is logged in
        google.script.run
          .withSuccessHandler(function (response) {
            if (response.success) {
              currentUser = response.data;
              loadPage("main");
            } else {
              loadPage("login");
            }
          })
          .withFailureHandler(function () {
            loadPage("login");
          })
          .getCurrentUser();
      };
    </script>
  </body>
</html>
